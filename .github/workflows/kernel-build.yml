name: Build Qualcomm ARM64 Kernel

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  KERNEL_REPO: https://gitlab.com/Linaro/arm64-laptops/linux.git
  KERNEL_BRANCH: qcom-laptops
  ARCH: arm64
  CROSS_COMPILE: aarch64-linux-gnu-
  APT_DIST: stable
  APT_COMPONENT: main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            bc \
            bison \
            flex \
            libssl-dev \
            libelf-dev \
            libncurses-dev \
            libdw-dev \
            dwarves \
            debhelper-compat \
            fakeroot \
            dpkg-dev \
            git \
            ccache \
            gcc-aarch64-linux-gnu

      - name: Clone kernel source
        run: |
          git clone --depth=1 \
            --branch "${KERNEL_BRANCH}" \
            "${KERNEL_REPO}" linux

      - name: Prepare kernel config
        working-directory: linux
        run: |
          export ARCH=${ARCH}
          export CROSS_COMPILE=${CROSS_COMPILE}

          make defconfig qcom_laptops.config
          make olddefconfig

      - name: Build kernel deb packages
        working-directory: linux
        run: |
          export ARCH=${ARCH}
          export CROSS_COMPILE=${CROSS_COMPILE}

          make -j$(nproc) bindeb-pkg DPKG_FLAGS="-d"

      - name: Collect deb packages
        run: |
          mkdir -p out
          mv *.deb out/

      - name: Build APT repository
        run: |
          set -e
          REPO=apt-repo
          ARCH=arm64

          
          mkdir -p \
            "${REPO}/pool/${APT_COMPONENT}" \
            "${REPO}/dists/${APT_DIST}/${APT_COMPONENT}/binary-${ARCH}"

          
          cp out/*.deb "${REPO}/pool/${APT_COMPONENT}/"

          
          cd "${REPO}"
          
          dpkg-scanpackages -a "${ARCH}" \
            "pool/${APT_COMPONENT}" \
            > "dists/${APT_DIST}/${APT_COMPONENT}/binary-${ARCH}/Packages"

          gzip -kf \
            "dists/${APT_DIST}/${APT_COMPONENT}/binary-${ARCH}/Packages"

          
          {
            echo "Origin: Qualcomm ARM64 Kernel"
            echo "Label: Qualcomm ARM64 Kernel"
            echo "Suite: ${APT_DIST}"
            echo "Codename: ${APT_DIST}"
            echo "Architectures: ${ARCH}"
            echo "Components: ${APT_COMPONENT}"
            echo "Description: Linux kernel for Qualcomm ARM64 laptops"
          } > "dists/${APT_DIST}/Release"


      - name: Upload APT repository artifact
        uses: actions/upload-artifact@v4
        with:
          name: apt-repo
          path: apt-repo
