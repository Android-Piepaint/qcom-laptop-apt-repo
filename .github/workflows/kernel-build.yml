name: Build Qualcomm ARM64 Kernel

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  KERNEL_REPO: https://gitlab.com/Linaro/arm64-laptops/linux.git
  KERNEL_BRANCH: qcom-laptops
  ARCH: arm64
  CROSS_COMPILE: aarch64-linux-gnu-
  APT_DIST: stable
  APT_COMPONENT: main

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            bc \
            bison \
            flex \
            libssl-dev \
            libelf-dev \
            libncurses-dev \
            libdw-dev \
            dwarves \
            debhelper-compat \
            fakeroot \
            dpkg-dev \
            git \
            ccache \
            gcc-aarch64-linux-gnu

      - name: Clone kernel source
        run: |
          git clone --depth=1 \
            --branch "${KERNEL_BRANCH}" \
            "${KERNEL_REPO}" linux

      - name: Prepare kernel config
        working-directory: linux
        run: |
          export ARCH=${ARCH}
          export CROSS_COMPILE=${CROSS_COMPILE}

          make defconfig qcom_laptops.config
          make olddefconfig

      - name: Build kernel deb packages
        working-directory: linux
        run: |
          export ARCH=${ARCH}
          export CROSS_COMPILE=${CROSS_COMPILE}

          make -j$(nproc) bindeb-pkg

      - name: Collect deb packages
        run: |
          mkdir -p out
          mv *.deb out/

      - name: Build APT repository
        run: |
          set -e

          REPO=apt-repo
          ARCH=arm64

          rm -rf "${REPO}"
          mkdir -p \
            "${REPO}/pool/${APT_COMPONENT}" \
            "${REPO}/dists/${APT_DIST}/${APT_COMPONENT}/binary-${ARCH}"

          cp out/*.deb "${REPO}/pool/${APT_COMPONENT}/"

          dpkg-scanpackages -a "${ARCH}" \
            "pool/${APT_COMPONENT}" \
            > "${REPO}/dists/${APT_DIST}/${APT_COMPONENT}/binary-${ARCH}/Packages"

          gzip -kf \
            "${REPO}/dists/${APT_DIST}/${APT_COMPONENT}/binary-${ARCH}/Packages"

          tee "${REPO}/dists/${APT_DIST}/Release" > /dev/null <<EOF
Origin: Qualcomm ARM64 Kernel
Label: Qualcomm ARM64 Kernel
Suite: ${APT_DIST}
Codename: ${APT_DIST}
Architectures: ${ARCH}
Components: ${APT_COMPONENT}
Description: Linux kernel for Qualcomm ARM64 laptops
EOF

      - name: Upload APT repository artifact
        uses: actions/upload-artifact@v4
        with:
          name: apt-repo
          path: apt-repo
